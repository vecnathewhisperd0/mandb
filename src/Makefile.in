# Programs Makefile for the man package.
#
# Copyright (C) 1994, 1995 Graeme Wilford.
#
# This file is part of man-db.
#
# man-db is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# man-db is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with man-db; if not, write to the Free Software Foundation,
# Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
#
# Sat Aug  6 13:28:44 BST 1994 Wilf. (G.Wilford@ee.surrey.ac.uk):

srcdir = @srcdir@
libdir = @libdir@
VPATH = @srcdir@
top_srcdir = @top_srcdir@
subdir = src
gnulocaledir = $(prefix)/share/locale

INSTALL = @INSTALL@
PACKAGE = @PACKAGE@
VERSION = @VERSION@

LIBS = @LIBINTL@ @LIBS@
DBLIBS = @DBLIBS@

include ../include/Defines

.PHONY: $(DEFAULT_TARGETS)

MANDEFS = -DCONFIG_FILE=\"$(config_file)\" \
	-DLOCALEDIR=\"$(gnulocaledir)\" $(DEFS_$(subst /,_,$@))
MANCPPFLAGS = -I../include -I$(top_srcdir) -I$(srcdir) -I../intl

#----------------------------------------------------------------#
# user changeable definitions can be found in ../include/Defines #
#----------------------------------------------------------------#

# You may need to modify these options if you have lex instead of flex
# or flex < 2.4.7 and you want to play with lexgrog.l (development only)
ifeq ($(LEXGROG_DEBUG),yes)
LFLAGS = -d
endif

PROGS = man manpath mandb apropos whatis catman lexgrog zsoelim
PUBTOOLS = accessdb
PRIVTOOLS = globbing manconv
TOOLS = $(PUBTOOLS) $(PRIVTOOLS) wrapper

# Special definitions for some compilations
DEFS_man.o = -DWHATIS=\"$(bindir)/$(whatis)\" \
	     -DAPROPOS=\"$(bindir)/$(apropos)\" \
	     -DSOELIM=\"$(bindir)/$(zsoelim)\" \
	     -DMANDB=\"$(bindir)/$(mandb)\"
DEFS_catman.o = -DMAN=\"$(bindir)/$(man)\"
DEFS_whatis.o = -DWHATIS
DEFS_apropos.o = -DAPROPOS
DEFS_encodings.o = -DMANCONV=\"$(libdir)/man-db/$(manconv)\"

DEFS_.depend_man.d = $(DEFS_man.o)
DEFS_.depend_catman.d = $(DEFS_catman.o)
DEFS_.depend_whatis.d = $(DEFS_whatis.o)
DEFS_.depend_apropos.d = $(DEFS_apropos.o)

DEFS_man = $(DEFS_man.o)
DEFS_catman = $(DEFS_catman.o)
DEFS_whatis = $(DEFS_whatis.o)
DEFS_apropos = $(DEFS_apropos.o)

# The default programs to build 
all: $(PROGS) $(PUBTOOLS) manconv wrapper man_db.conf

#--------------------#
# some general rules #
#--------------------#

../lib/libman.a:
	$(MAKE) -C ../lib

../libdb/libmandb.a:
	$(MAKE) -C ../libdb

#-------------------------------------------------------------------#
# The individual program dependencies...                            #
# note that anything requiring compression.o must also have either  #
# security.o (man), or fake_security.o (others) in the object list. #
#-------------------------------------------------------------------#

man: security.o convert_name.o manp.o ult_src.o compression.o \
     filenames.o util.o globbing.o encodings.o man.o

mandb: security.o manp.o util.o ult_src.o check_mandirs.o \
       descriptions.o descriptions_store.o \
       filenames.o straycats.o compression.o lexgrog.o encodings.o globbing.o \
       mandb.o

wrapper:	LDLIBS=-lc

catman manpath whatis apropos: fake_security.o manp.o
catman manpath whatis apropos accessdb: util.o 
man mandb catman whatis apropos accessdb: ../libdb/libmandb.a

man mandb catman whatis apropos accessdb: LDLIBS += $(DBLIBS)

whatis apropos: encodings.o
whatis apropos: LDLIBS += $(LIBICONV)

$(PROGS) $(TOOLS): version.o ../lib/libman.a

apropos: whatis.c
	$(LINK.c) $^ $(LDLIBS) -o $@

# Rules to test code as program unit
lexgrog: lexgrog.c compression.o descriptions.o encodings.o fake_security.o \
	ult_src.o util.o
	$(LINK.c) -DTEST $^ $(LDLIBS) -o $@

globbing: globbing.c util.o
	$(LINK.c) -DTEST $^ $(LDLIBS) -o $@

# The standard targets
install:
	$(MKINSTALLDIRS) $(DESTDIR)$(bindir) $(DESTDIR)$(sbindir) \
	                 $(DESTDIR)$(libdir)/man-db
	$(INSTALL_PROGRAM) $(man_install_flags) man $(DESTDIR)$(bindir)/$(man)
	$(INSTALL_PROGRAM) $(man_install_flags) mandb $(DESTDIR)$(bindir)/$(mandb)
	$(INSTALL_PROGRAM) manpath $(DESTDIR)$(bindir)/$(manpath)
	$(INSTALL_PROGRAM) catman $(DESTDIR)$(bindir)/$(catman)
	$(INSTALL_PROGRAM) whatis $(DESTDIR)$(bindir)/$(whatis)
	$(INSTALL_PROGRAM) apropos $(DESTDIR)$(bindir)/$(apropos)
	$(INSTALL_PROGRAM) lexgrog $(DESTDIR)$(bindir)/$(lexgrog)
	$(INSTALL_PROGRAM) zsoelim $(DESTDIR)$(bindir)/$(zsoelim)
	for j in $(PUBTOOLS); do \
		if test -x $$j; then \
			$(INSTALL_PROGRAM) $$j $(DESTDIR)$(sbindir)/$$j; \
		fi; \
	done
	for j in $(PRIVTOOLS); do \
		if test -x $$j; then \
			$(INSTALL_PROGRAM) $$j $(DESTDIR)$(libdir)/man-db/$$j; \
		fi; \
	done
	@if test -f $(DESTDIR)$(config_file); then \
		echo " "; \
		echo "$(DESTDIR)$(config_file) already exists. Overwrite manually if necessary"; \
		echo " "; \
	else \
		$(MKINSTALLDIRS) $(dir $(DESTDIR)$(config_file)); \
		echo "$(INSTALL_DATA) man_db.conf $(DESTDIR)$(config_file)"; \
		$(INSTALL_DATA) man_db.conf $(DESTDIR)$(config_file); \
	fi

uninstall:
	rm -f $(addprefix $(DESTDIR)$(bindir)/, $(PROGS))
	rm -f $(addprefix $(DESTDIR)$(sbindir)/, $(PUBTOOLS))
	rm -f $(addprefix $(DESTDIR)$(libdir)/man-db/, $(PRIVTOOLS))
	@echo "Please remove $(DESTDIR)$(config_file) manually if necessary"
#	rm -f $(DESTDIR)$(config_file)

mostlyclean clean: 
	rm -rf .depend
	rm -f *.o *.i *~ core
	rm -f $(PROGS) $(TOOLS)

distclean: lexgrog.c zsoelim.c clean
	rm -f *.out Makefile man_db.conf

realclean: distclean
	rm -f lexgrog.c zsoelim.c tags

TAGS:
	$(MKTAGS) $(srcdir)/*.[chl]
	
# These lines sort out proper dependencies.
ifeq (,$(findstring clean,$(MAKECMDGOALS)))
  SRCS = $(notdir $(wildcard $(srcdir)/*.c))
  -include $(SRCS:%.c=.depend/%.d)
endif
